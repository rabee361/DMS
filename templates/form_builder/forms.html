{% extends "base.html" %}

{% block title %}قائمة الاستبيانات{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="h2">الاستبيانات</h1>
    <a href="{% url 'add_form' %}" class="btn btn-primary">إضافة +</a>
</div>

<div class="table-container">
    <div class="table-controls">
        <div class="search-controls">
            <input hx-get="{% url 'users_list' %}" type="text" name="q" class="search-input" placeholder="البحث بالاسم..." value="{{ request.GET.q }}"/>
        </div>
        <div class="action-controls">
            <select id="bulkAction" name="action" class="action-select">
                <option value="" selected disabled>اختر إجراء</option>
                <option value="delete">حذف الاستبيانات المحددة</option>
            </select>
            <button type="button" class="do-action-btn" onclick="executeBulkAction()">تنفيذ الإجراء</button>
        </div>
    </div>

    <form method="post" action="#"  id="bulkActionForm">
        {% csrf_token %}
        <input type="hidden" name="selected_ids" id="selectedIds">
        <input type="hidden" name="action" id="selectedAction">
        
        <table class="data-table">

            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll"></th>
                    <th>الرقم</th>
                    <th>اسم الاستبيان</th>
                    <th>عنوان</th>
                    <th>اللغة</th>
                    <th>تاريخ الإنشاء</th>
                    <th>إجراءات</th>
                </tr>
            </thead>

            {% for form in forms %}
            <tr onclick="clickHandler(event)" data-link="{% url 'form_detail' form.id %}">
                <td onclick="event.stopPropagation();">
                    <input type="checkbox" class="item-checkbox" value="{{ form.id }}">
                </td>
                <td>{{ form.id }}</td>
                <td>{{ form.name|cut:"form_builder_" }}</td>
                <td>{{ form.title }}</td>
                <td>{{ form.language }}</td>
                <td>{{ form.created_at }}</td>
                <td onclick="event.stopPropagation();">
                    <div class="action-buttons">
                        <a href="{% url 'delete_form' form.id %}" class="delete-btn">
                            <i class="bi bi-trash"></i>
                        </a>
                        <a href="#" class="copy-btn" data-url="{{ form.get_absolute_url }}">
                            <i class="bi bi-clipboard"></i>
                        </a>
                        <a href="{% url 'update_form' form.id %}" class="edit-btn">
                            <i class="bi bi-pencil"></i>
                        </a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </table>

    </form>

    <div class="pagination-container">
        <ul class="pagination">
            {% if page_obj %}
                {% if page_obj.has_previous %}
                    <li><a href="?page={{ page_obj.previous_page_number }}" class="page-link">السابق</a></li>
                    <li><a href="#" class="page-link">{{ page_obj.number|add:'-1' }}</a></li>
                {% endif %}
                <li><a href="#" class="page-link active">{{ page_obj.number }}</a></li>
                {% if page_obj.has_next %}
                    <li><a href="#" class="page-link">{{ page_obj.number|add:'1' }}</a></li>
                    <li><a href="?page={{ page_obj.next_page_number }}" class="page-link">التالي</a></li>
                {% endif %}
            {% endif %}
        </ul>
    </div>
</div>

<!-- Toast notification for copy feedback -->
<div id="toast" class="toast-notification">
    <div class="toast-content"></div>
</div>

<style>
    .toast-notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #333;
        color: white;
        padding: 12px 20px;
        border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 9999;
        font-size: 14px;
        max-width: 300px;
        text-align: center;
    }
    
    .toast-notification.show {
        opacity: 1;
    }
    
    .copy-btn {
        cursor: pointer;
        color: #0d6efd;
        margin-left: 8px;
    }
    
    .copy-btn:hover {
        color: #0a58ca;
    }

    .url-display {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 20px rgba(0,0,0,0.2);
        z-index: 9999;
        max-width: 90%;
    }
    
    .url-display input {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .url-display .close-btn {
        background: #f44336;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
    }
</style>

<script>
    // Initialize copy buttons when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        const copyButtons = document.querySelectorAll('.copy-btn');
        copyButtons.forEach(button => {
            button.addEventListener('click', copyButtonHandler);
        });
    });

    // Show toast notification with message
    function showToast(message) {
        const toast = document.getElementById('toast');
        const toastContent = toast.querySelector('.toast-content');
        
        toastContent.textContent = message;
        toast.classList.add('show');
        
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    // Show selectable URL in modal for manual copying
    function showSelectableUrl(url) {
        // Create modal for URL display
        const modal = document.createElement('div');
        modal.className = 'url-display';
        modal.innerHTML = `
            <p>انسخ الرابط التالي:</p>
            <input type="text" value="${url}" readonly>
            <button class="close-btn">إغلاق</button>
        `;
        
        document.body.appendChild(modal);
        
        // Select the URL text for easy copying
        const input = modal.querySelector('input');
        input.focus();
        input.select();
        
        // Close modal when button is clicked
        const closeBtn = modal.querySelector('.close-btn');
        closeBtn.addEventListener('click', () => {
            document.body.removeChild(modal);
        });
    }
</script>
{% endblock %}
