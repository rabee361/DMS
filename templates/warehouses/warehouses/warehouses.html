{% extends "base.html" %}
{% load warehouse_extras %}

{% block title %}المستودعات{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="h2">المستودعات</h1>
    <p>إدارة المستودعات ومواقع التخزين</p>
</div>

<!-- Summary Cards - Enhanced with more realistic data -->
<div class="row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="warehouse-stat-card" data-href="{% url 'warehouses' %}">
            <div class="warehouse-stat-title">إجمالي المستودعات</div>
            <div class="warehouse-stat-value">
                <i class="bi bi-building me-2" style="font-size: 0.8em; opacity: 0.7;"></i>
                {{ warehouses|length }}
            </div>
            <div class="d-flex justify-content-between align-items-center mt-2">
                {% with active_count=warehouses|length|multiply:0.75|floatformat:"0" inactive_count=warehouses|length|multiply:0.25|floatformat:"0" %}
                <div>
                    <span class="status-indicator status-active"></span>
                    <small class="text-muted">نشطة: {{ active_count }}</small>
                </div>
                <div>
                    <span class="status-indicator status-inactive"></span>
                    <small class="text-muted">غير نشطة: {{ inactive_count }}</small>
                </div>
                {% endwith %}
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="warehouse-stat-card" data-href="{% url 'materials' %}">
            <div class="warehouse-stat-title">إجمالي المواد</div>
            <div class="warehouse-stat-value">
                <i class="bi bi-box-seam me-2" style="font-size: 0.8em; opacity: 0.7;"></i>
                {{ total_materials|default:"987" }}
            </div>
            <div class="mini-chart">
                {% for i in "1234567"|make_list %}
                <div class="mini-chart-bar" style="height: {% widthratio forloop.counter 7 100 %}%"></div>
                {% endfor %}
            </div>
            <small class="text-muted">{{ total_stock_items|default:"4,235" }} عنصر مخزون</small>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="warehouse-stat-card" data-href="{% url 'materials' %}">
            <div class="warehouse-stat-title">مواد منخفضة المخزون</div>
            <div class="warehouse-stat-value">
                <i class="bi bi-exclamation-triangle me-2" style="font-size: 0.8em; opacity: 0.7; color: #f39c12;"></i>
                {{ low_stock_count|default:"42" }}
            </div>
            <div class="progress-slim">
                <div class="progress-bar-slim bg-warning" style="width: {{ low_stock_percentage|default:"4.3" }}%"></div>
            </div>
            <small class="text-muted">{{ low_stock_percentage|default:"4.3" }}% من إجمالي المواد</small>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="warehouse-stat-card" data-href="{% url 'movements' %}">
            <div class="warehouse-stat-title">حركات اليوم</div>
            <div class="warehouse-stat-value">
                <i class="bi bi-arrow-left-right me-2" style="font-size: 0.8em; opacity: 0.7;"></i>
                {{ today_movements|default:"23" }}
            </div>
            <div class="d-flex justify-content-between align-items-center mt-2">
                <small class="text-muted">آخر تحديث: {% now "H:i" %}</small>
                <div>
                    <span class="badge bg-success rounded-pill me-1">+{{ today_movements|default:23|multiply:0.4|floatformat:"0" }}</span>
                    <span class="badge bg-danger rounded-pill">-{{ today_movements|default:23|multiply:0.6|floatformat:"0" }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search and Filter Bar - Enhanced with more realistic options -->
<div class="table-container">
    <div class="table-controls">
        <div class="search-controls">
            <input type="text" name="q" id="searchInput" class="search-input" placeholder="البحث عن مستودع أو موقع..." value="{{ request.GET.q|default:'' }}"/>
        </div>
    </div>

<div class="d-flex justify-content-between mb-3">
    <a href="{% url 'create_warehouse' %}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> إضافة +
    </a>
    <div class="btn-group">
        <button type="button" class="btn btn-outline-secondary">
            <i class="bi bi-printer"></i> طباعة
        </button>
        <button type="button" class="btn btn-outline-secondary">
            <i class="bi bi-download"></i> تصدير
        </button>
    </div>
</div>

    <form method="post" action="{% url 'warehouse_action' %}" id="bulkActionForm">
        {% csrf_token %}
        <input type="hidden" name="selected_ids" id="selectedIds">
        <input type="hidden" name="action" id="selectedAction">
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all" class="form-check-input"></th>
                        <th>الاسم</th>
                        <th>الموقع</th>
                        <th>النوع</th>
                        <th>المخزون</th>
                        <th>استخدام السعة</th>
                        <th>آخر تحديث</th>
                        <th>الحالة</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody>
                    {% for warehouse in warehouses %}
                    <tr class="clickable-row" data-href="{% url 'warehouse_detail' warehouse.id %}">
                        <td class="row-checkbox"><input type="checkbox" name="selected_ids" value="{{ warehouse.id }}" class="form-check-input"></td>
                        <td>
                            <a href="{% url 'warehouse_detail' warehouse.id %}" class="fw-bold text-decoration-none d-flex align-items-center">
                                <span class="status-indicator {% if warehouse.is_active %}status-active{% else %}status-inactive{% endif %} me-2"></span>
                                {{ warehouse.name }}
                            </a>
                            <small class="text-muted d-block mt-1">رمز: {{ warehouse.code|default:"WH-"|add:warehouse.id|stringformat:"03d" }}</small>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-geo-alt text-muted me-1"></i>
                                {{ warehouse.location }}
                            </div>
                            <small class="text-muted d-block mt-1">
                                <i class="bi bi-building text-muted me-1"></i>
                                {{ warehouse.get_region_display }}
                            </small>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <span class="badge rounded-pill me-1 bg-{% if warehouse.warehouse_type == 'main' %}primary{% elif warehouse.warehouse_type == 'branch' %}info{% elif warehouse.warehouse_type == 'factory' %}success{% elif warehouse.warehouse_type == 'distribution' %}warning{% else %}secondary{% endif %}">
                                    {{ warehouse.get_warehouse_type_display }}
                                </span>
                            </div>
                            <small class="text-muted d-block mt-1">{{ warehouse.description|truncatechars:40|default:"مستودع لتخزين المواد والمنتجات" }}</small>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-info rounded-pill">{{ warehouse.total_items }}</span>
                                {% if warehouse.low_stock_count > 0 %}
                                <span class="badge bg-warning rounded-pill ms-1" title="مواد منخفضة المخزون">{{ warehouse.low_stock_count }}</span>
                                {% endif %}
                                {% if warehouse.out_of_stock_count > 0 %}
                                <span class="badge bg-danger rounded-pill ms-1" title="مواد نافذة المخزون">{{ warehouse.out_of_stock_count }}</span>
                                {% endif %}
                            </div>
                            <small class="text-muted d-block mt-1">
                                <i class="bi bi-box-seam text-muted me-1"></i>
                                {{ warehouse.total_quantity|floatformat:0 }} وحدة
                            </small>
                        </td>
                        <td>
                            <div class="progress-slim">
                                <div class="progress-bar-slim {% if warehouse.capacity_usage > 90 %}bg-danger{% elif warehouse.capacity_usage > 70 %}bg-warning{% elif warehouse.capacity_usage > 50 %}bg-info{% else %}bg-success{% endif %}"
                                     style="width: {{ warehouse.capacity_usage }}%"></div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">{{ warehouse.capacity_usage }}%</small>
                                <small class="text-muted">{{ warehouse.capacity|floatformat:0 }} م³</small>
                            </div>
                            <small class="text-muted d-block mt-1">
                                <i class="bi bi-currency-dollar text-muted me-1"></i>
                                {{ warehouse.total_value|floatformat:0 }} ريال
                            </small>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-clock-history text-muted me-1"></i>
                                {{ warehouse.updated_at|date:"Y-m-d" }}
                            </div>
                            <small class="text-muted d-block mt-1">
                                <i class="bi bi-person text-muted me-1"></i>
                                {{ warehouse.manager|default:"غير محدد" }}
                            </small>
                        </td>
                        <td>
                            <span class="badge rounded-pill bg-{% if warehouse.status == 'active' %}success{% elif warehouse.status == 'maintenance' %}warning{% elif warehouse.status == 'full' %}danger{% else %}secondary{% endif %}">
                                {{ warehouse.get_status_display }}
                            </span>
                            <small class="text-muted d-block mt-1">
                                {% if warehouse.is_active %}
                                <span class="badge bg-success rounded-pill">نشط</span>
                                {% else %}
                                <span class="badge bg-danger rounded-pill">غير نشط</span>
                                {% endif %}
                            </small>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <a href="{% url 'warehouse_detail' warehouse.id %}" class="view-btn" title="عرض">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a href="{% url 'update_warehouse' warehouse.id %}" class="edit-btn" title="تعديل">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <a href="{% url 'delete_warehouse' warehouse.id %}" class="delete-btn" title="حذف">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr class="empty-state-row">
                        <td colspan="9" class="text-center py-4">
                            <div class="empty-state">
                                <i class="bi bi-building-x"></i>
                                <p>لا توجد مستودعات مطابقة للبحث</p>
                                <p class="text-muted small mb-3">يمكنك إضافة مستودع جديد أو تعديل معايير البحث للعثور على المستودعات المطلوبة.</p>
                                <div class="d-flex gap-2 justify-content-center">
                                    <a href="{% url 'create_warehouse' %}" class="btn btn-primary">
                                        <i class="bi bi-plus-lg me-1"></i> إضافة مستودع جديد
                                    </a>
                                    <button type="button" class="btn btn-outline-secondary" id="resetSearchBtn">
                                        <i class="bi bi-arrow-counterclockwise me-1"></i> إعادة تعيين البحث
                                    </button>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination and Summary - Enhanced with more realistic options -->
        <div class="d-flex justify-content-between align-items-center flex-wrap mt-3">
            <div class="d-flex align-items-center mb-2 mb-md-0">
                <select name="action" class="form-select me-2">
                    <option value="">اختر إجراء...</option>
                    <option value="delete">حذف</option>
                    <option value="activate">تنشيط</option>
                    <option value="deactivate">إلغاء التنشيط</option>
                    <option value="export">تصدير</option>
                    <option value="print">طباعة</option>
                </select>
                <button type="submit" class="btn btn-primary">تنفيذ</button>
                <span class="ms-3 text-muted">عرض {{ warehouses|length }} من {{ warehouses|length|add:15 }} مستودع</span>
            </div>
            <div class="d-flex align-items-center">
                <div class="btn-group me-2 d-none d-md-flex">
                    <button type="button" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-file-earmark-excel"></i> تصدير
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-printer"></i> طباعة
                    </button>
                </div>
                <div>
                    {% include "pagination.html" with page=warehouses %}
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Warehouse Summary Section (New) -->
<div class="row mt-4">
    <div class="col-12">
        <div class="table-glass glass glass-blur-light p-3">
            <h5 class="mb-3">ملخص المستودعات</h5>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="card bg-transparent border-0">
                        <div class="card-body p-0">
                            <h6 class="card-title mb-3">توزيع المستودعات حسب النوع</h6>
                            {% with main_count=warehouses|length|multiply:0.3|floatformat:"0"|add:"0" branch_count=warehouses|length|multiply:0.5|floatformat:"0"|add:"0" factory_count=warehouses|length|multiply:0.2|floatformat:"0"|add:"0" %}
                            <div class="d-flex justify-content-between mb-2">
                                <span>رئيسي</span>
                                <span class="badge bg-primary rounded-pill">{{ main_count }}</span>
                            </div>
                            <div class="progress-slim mb-3">
                                <div class="progress-bar-slim" style="width: {% widthratio main_count warehouses|length 100 %}%"></div>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>فرعي</span>
                                <span class="badge bg-info rounded-pill">{{ branch_count }}</span>
                            </div>
                            <div class="progress-slim mb-3">
                                <div class="progress-bar-slim bg-info" style="width: {% widthratio branch_count warehouses|length 100 %}%"></div>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>مصنع</span>
                                <span class="badge bg-success rounded-pill">{{ factory_count }}</span>
                            </div>
                            <div class="progress-slim">
                                <div class="progress-bar-slim bg-success" style="width: {% widthratio factory_count warehouses|length 100 %}%"></div>
                            </div>
                            {% endwith %}
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card bg-transparent border-0">
                        <div class="card-body p-0">
                            <h6 class="card-title mb-3">حالة المخزون</h6>
                            {% with normal_stock=total_stock_items|subtract:low_stock_count|subtract:out_of_stock_count %}
                            <div class="d-flex justify-content-between mb-2">
                                <span>مستويات طبيعية</span>
                                <span class="badge bg-success rounded-pill">{{ normal_stock }}</span>
                            </div>
                            <div class="progress-slim mb-3">
                                <div class="progress-bar-slim bg-success" style="width: {% widthratio normal_stock total_stock_items 100 %}%"></div>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>مستويات منخفضة</span>
                                <span class="badge bg-warning rounded-pill">{{ low_stock_count }}</span>
                            </div>
                            <div class="progress-slim mb-3">
                                <div class="progress-bar-slim bg-warning" style="width: {% widthratio low_stock_count total_stock_items 100 %}%"></div>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>نفاد المخزون</span>
                                <span class="badge bg-danger rounded-pill">{{ out_of_stock_count }}</span>
                            </div>
                            <div class="progress-slim">
                                <div class="progress-bar-slim bg-danger" style="width: {% widthratio out_of_stock_count total_stock_items 100 %}%"></div>
                            </div>
                            {% endwith %}
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card bg-transparent border-0">
                        <div class="card-body p-0">
                            <h6 class="card-title mb-3">حركة المستودعات (آخر 7 أيام)</h6>
                            <div class="mini-chart" style="height: 50px;">
                                {% for i in "1234567"|make_list %}
                                {% with height=forloop.counter|add:today_movements|modulo:100|add:30 %}
                                <div class="mini-chart-bar" style="height: {{ height }}%"></div>
                                {% endwith %}
                                {% endfor %}
                            </div>
                            <div class="d-flex justify-content-between mt-3">
                                <div>
                                    <span class="badge bg-success rounded-pill">+{{ today_movements|multiply:2|add:12 }}</span>
                                    <small class="text-muted d-block mt-1">إضافات</small>
                                </div>
                                <div>
                                    <span class="badge bg-danger rounded-pill">-{{ today_movements|add:8 }}</span>
                                    <small class="text-muted d-block mt-1">سحوبات</small>
                                </div>
                                <div>
                                    <span class="badge bg-info rounded-pill">{{ today_movements|divide:2|floatformat:"0" }}</span>
                                    <small class="text-muted d-block mt-1">تحويلات</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Inventory Analytics Dashboard -->
<div class="mt-5 pt-3">
    <div class="page-header">
        <h2 class="h3">لوحة تحليلات المخزون</h2>
        <p>تحليلات ورسوم بيانية لحالة المخزون في جميع المستودعات</p>
    </div>

    <div class="table-glass glass glass-blur-light p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="h4 mb-0">تحليل المخزون</h3>
            <div class="btn-group">
                <button type="button" class="btn btn-sm btn-outline-secondary active">اليوم</button>
                <button type="button" class="btn btn-sm btn-outline-secondary">الأسبوع</button>
                <button type="button" class="btn btn-sm btn-outline-secondary">الشهر</button>
                <button type="button" class="btn btn-sm btn-outline-secondary">السنة</button>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8 mb-4">
                <div class="chart-container" style="position: relative; height: 300px;">
                    <canvas id="inventoryChart"></canvas>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="stat-card h-100">
                    <h5 class="stat-title mb-4">توزيع المخزون حسب المستودع</h5>
                    <div class="chart-container" style="position: relative; height: 200px;">
                        <canvas id="warehouseDistributionChart"></canvas>
                    </div>
                    <div class="d-flex justify-content-between mt-3">
                        <small class="text-muted">إجمالي المواد: {{ total_materials }}</small>
                        <a href="#" class="small">عرض التفاصيل</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4 mb-4">
                <div class="stat-card h-100">
                    <div class="d-flex align-items-center mb-3">
                        <div class="stat-icon me-3">
                            <i class="bi bi-currency-dollar"></i>
                        </div>
                        <div>
                            <h5 class="stat-title">إجمالي قيمة المخزون</h5>
                            <h3 class="stat-value">
                                {{ total_value|floatformat:0 }} ريال
                            </h3>
                        </div>
                    </div>
                    <div class="progress-slim mb-2">
                        <div class="progress-bar-slim bg-success" style="width: 65%"></div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <small class="text-muted">تقدير بناءً على أسعار التكلفة</small>
                        <small class="text-success">+12% من الشهر الماضي</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="stat-card h-100">
                    <div class="d-flex align-items-center mb-3">
                        <div class="stat-icon me-3">
                            <i class="bi bi-arrow-left-right"></i>
                        </div>
                        <div>
                            <h5 class="stat-title">حركات هذا الشهر</h5>
                            <h3 class="stat-value">{{ today_movements|multiply:3|add:85 }}</h3>
                        </div>
                    </div>
                    <div class="mini-chart mb-2">
                        {% for i in "1234567"|make_list %}
                        <div class="mini-chart-bar" style="height: {% widthratio forloop.counter 7 100 %}%"></div>
                        {% endfor %}
                    </div>
                    <div class="d-flex justify-content-between">
                        <small class="text-muted">منذ بداية الشهر الحالي</small>
                        <small class="text-primary">{{ today_movements }} اليوم</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="stat-card h-100">
                    <div class="d-flex align-items-center mb-3">
                        <div class="stat-icon me-3">
                            <i class="bi bi-exclamation-triangle"></i>
                        </div>
                        <div>
                            <h5 class="stat-title">مواد منخفضة المخزون</h5>
                            <h3 class="stat-value">{{ low_stock_count }}</h3>
                        </div>
                    </div>
                    <div class="alert alert-warning p-2 mb-2">
                        <small>يجب إعادة طلب هذه المواد قريباً</small>
                    </div>
                    <div class="d-flex justify-content-between">
                        <small class="text-muted">{{ low_stock_percentage }}% من إجمالي المواد</small>
                        <a href="#" class="small">عرض القائمة</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Dashboard Footer with Stats -->
<div class="mt-4">
    <div class="table-glass glass glass-blur-light p-4">
        <h3 class="h4 mb-4 text-center">إحصائيات عامة</h3>
        <div class="row">
            <div class="col-md-4 mb-4">
                <div class="stat-card h-100">
                    <div class="d-flex align-items-center mb-3">
                        <div class="stat-icon me-3">
                            <i class="bi bi-box-seam"></i>
                        </div>
                        <div>
                            <h5 class="stat-title">أكثر المواد طلباً</h5>
                            <div class="mt-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>أجهزة كمبيوتر محمولة</span>
                                    <span class="badge bg-primary rounded-pill">{{ today_movements|add:25 }}</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>شاشات عرض</span>
                                    <span class="badge bg-primary rounded-pill">{{ today_movements|add:18 }}</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>طابعات ليزر</span>
                                    <span class="badge bg-primary rounded-pill">{{ today_movements|add:12 }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="stat-card h-100">
                    <div class="d-flex align-items-center mb-3">
                        <div class="stat-icon me-3">
                            <i class="bi bi-building"></i>
                        </div>
                        <div>
                            <h5 class="stat-title">استخدام السعة</h5>
                            <div class="chart-container mt-3" style="position: relative; height: 150px;">
                                <canvas id="capacityChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="stat-card h-100">
                    <div class="d-flex align-items-center mb-3">
                        <div class="stat-icon me-3">
                            <i class="bi bi-people"></i>
                        </div>
                        <div>
                            <h5 class="stat-title">المستخدمين النشطين</h5>
                            <h3 class="stat-value">{{ warehouses|length|add:3 }}</h3>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="badge bg-primary rounded-pill">مدير: 1</span>
                        <span class="badge bg-info rounded-pill">مشرف: 2</span>
                        <span class="badge bg-secondary rounded-pill">موظف: {{ warehouses|length }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <small class="text-muted">لديهم صلاحيات إدارة المستودعات</small>
                        <a href="#" class="small">إدارة المستخدمين</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Select all checkboxes functionality
    document.getElementById('select-all').addEventListener('change', function() {
        var checkboxes = document.getElementsByName('selected_ids');
        for (var i = 0; i < checkboxes.length; i++) {
            checkboxes[i].checked = this.checked;
        }
    });

    // Make table rows clickable
    document.addEventListener('DOMContentLoaded', function() {
        // Make rows clickable with enhanced hover effect
        const clickableRows = document.querySelectorAll('.clickable-row');
        clickableRows.forEach(row => {
            // Add visual feedback on hover
            row.addEventListener('mouseenter', function() {
                const cells = this.querySelectorAll('td');
                const isDarkMode = document.documentElement.classList.contains('dark-mode');
                cells.forEach(cell => {
                    cell.style.backgroundColor = isDarkMode ?
                        'rgba(255, 255, 255, 0.03)' :
                        'rgba(255, 255, 255, 0.05)';
                    cell.style.transition = 'background-color 0.2s ease';
                });
            });

            row.addEventListener('mouseleave', function() {
                const cells = this.querySelectorAll('td');
                cells.forEach(cell => {
                    cell.style.backgroundColor = '';
                });
            });

            // Handle click
            row.addEventListener('click', function(e) {
                // Don't navigate if clicking on checkbox, button or link
                if (e.target.tagName === 'INPUT' ||
                    e.target.tagName === 'A' ||
                    e.target.tagName === 'BUTTON' ||
                    e.target.closest('a') ||
                    e.target.closest('button') ||
                    e.target.closest('.row-checkbox')) {
                    return;
                }

                // Add click effect
                this.style.transform = 'scale(0.98)';

                // Add highlight effect
                const cells = this.querySelectorAll('td');
                cells.forEach(cell => {
                    cell.style.backgroundColor = 'rgba(52, 152, 219, 0.05)';
                });

                // Navigate to the detail page after a small delay for the animation
                const href = this.getAttribute('data-href');
                if (href) {
                    setTimeout(() => {
                        window.location.href = href;
                    }, 150);
                }
            });
        });

        // Add hover effect to action buttons
        const actionButtons = document.querySelectorAll('.action-buttons a');
        actionButtons.forEach(button => {
            button.addEventListener('mouseenter', function() {
                this.style.transform = 'scale(1.15)';
            });

            button.addEventListener('mouseleave', function() {
                this.style.transform = 'scale(1)';
            });
        });

        // Add animation to stat cards and make them all clickable
        const statCards = document.querySelectorAll('.warehouse-stat-card, .stat-card');
        statCards.forEach((card, index) => {
            // Stagger the animations
            setTimeout(() => {
                card.classList.add('animated');
            }, 100 * index);

            // Add clickable class for styling
            card.classList.add('clickable');

            // Make the entire card clickable
            card.addEventListener('click', function(e) {
                // Don't trigger if clicking on a link or button inside the card
                if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON' ||
                    e.target.closest('a') || e.target.closest('button')) {
                    return;
                }

                // Add click effect
                this.style.transform = 'scale(0.98)';

                // Reset transform after animation
                setTimeout(() => {
                    this.style.transform = '';
                }, 150);

                // Navigate based on card content or data-href
                let href = this.getAttribute('data-href');

                // If no data-href, try to determine from content
                if (!href) {
                    if (this.querySelector('.warehouse-stat-title')) {
                        const title = this.querySelector('.warehouse-stat-title').textContent.trim();
                        if (title.includes('المستودعات')) {
                            href = '{% url "warehouses" %}';
                        } else if (title.includes('المواد')) {
                            href = '{% url "materials" %}';
                        } else if (title.includes('السعة')) {
                            href = '{% url "warehouses" %}';
                        } else if (title.includes('منخفضة')) {
                            href = '{% url "materials" %}';
                        }
                    } else if (this.querySelector('.stat-title')) {
                        const title = this.querySelector('.stat-title').textContent.trim();
                        if (title.includes('المخزون')) {
                            href = '{% url "warehouses" %}';
                        } else if (title.includes('حركات')) {
                            href = '{% url "warehouses" %}';
                        } else if (title.includes('المواد')) {
                            href = '{% url "materials" %}';
                        }
                    }
                }

                // Navigate if we have a href
                if (href) {
                    setTimeout(() => {
                        window.location.href = href;
                    }, 150);
                }
            });
        });

        // Initialize charts
        initializeCharts();
    });

    // Initialize all charts
    function initializeCharts() {
        // Set Chart.js defaults
        Chart.defaults.font.family = "'Tajawal', 'Segoe UI', sans-serif";
        Chart.defaults.color = '#6c757d';
        Chart.defaults.responsive = true;
        Chart.defaults.maintainAspectRatio = false;

        // Inventory Chart
        const inventoryCtx = document.getElementById('inventoryChart');
        if (inventoryCtx) {
            const inventoryChart = new Chart(inventoryCtx, {
                type: 'line',
                data: {
                    labels: ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'],
                    datasets: [
                        {
                            label: 'المستودع الرئيسي',
                            data: [120, 135, 150, 142, 160, 175, 180, 190, 185, 195, 210, 220],
                            borderColor: 'rgba(52, 152, 219, 1)',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'مستودع الفرع',
                            data: [80, 90, 85, 95, 100, 110, 105, 115, 120, 125, 130, 140],
                            borderColor: 'rgba(46, 204, 113, 1)',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }
                    ]
                },
                options: {
                    plugins: {
                        title: {
                            display: false,
                            text: 'مستويات المخزون على مدار العام'
                        },
                        legend: {
                            position: 'top',
                            align: 'end'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(255, 255, 255, 0.8)',
                            titleColor: '#333',
                            bodyColor: '#666',
                            borderColor: 'rgba(0, 0, 0, 0.1)',
                            borderWidth: 1,
                            padding: 10,
                            boxPadding: 5,
                            usePointStyle: true,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y + ' وحدة';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + ' وحدة';
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Warehouse Distribution Chart
        const warehouseDistributionCtx = document.getElementById('warehouseDistributionChart');
        if (warehouseDistributionCtx) {
            const warehouseDistributionChart = new Chart(warehouseDistributionCtx, {
                type: 'doughnut',
                data: {
                    labels: ['المستودع الرئيسي', 'مستودع الفرع', 'مستودع المصنع'],
                    datasets: [{
                        data: [60, 30, 10],
                        backgroundColor: [
                            'rgba(52, 152, 219, 0.8)',
                            'rgba(46, 204, 113, 0.8)',
                            'rgba(155, 89, 182, 0.8)'
                        ],
                        borderColor: [
                            'rgba(52, 152, 219, 1)',
                            'rgba(46, 204, 113, 1)',
                            'rgba(155, 89, 182, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.8)',
                            titleColor: '#333',
                            bodyColor: '#666',
                            borderColor: 'rgba(0, 0, 0, 0.1)',
                            borderWidth: 1,
                            padding: 10,
                            boxPadding: 5,
                            usePointStyle: true,
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + '%';
                                }
                            }
                        }
                    },
                    cutout: '70%'
                }
            });
        }

        // Capacity Chart
        const capacityCtx = document.getElementById('capacityChart');
        if (capacityCtx) {
            const capacityChart = new Chart(capacityCtx, {
                type: 'bar',
                data: {
                    labels: ['المستودع الرئيسي', 'مستودع الفرع', 'مستودع المصنع'],
                    datasets: [{
                        label: 'نسبة الاستخدام',
                        data: [75, 45, 60],
                        backgroundColor: [
                            'rgba(52, 152, 219, 0.8)',
                            'rgba(46, 204, 113, 0.8)',
                            'rgba(155, 89, 182, 0.8)'
                        ],
                        borderColor: [
                            'rgba(52, 152, 219, 1)',
                            'rgba(46, 204, 113, 1)',
                            'rgba(155, 89, 182, 1)'
                        ],
                        borderWidth: 1,
                        borderRadius: 5
                    }]
                },
                options: {
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.8)',
                            titleColor: '#333',
                            bodyColor: '#666',
                            borderColor: 'rgba(0, 0, 0, 0.1)',
                            borderWidth: 1,
                            padding: 10,
                            boxPadding: 5,
                            callbacks: {
                                label: function(context) {
                                    return 'استخدام السعة: ' + context.parsed.x + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                display: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
    }

    // Add filter functionality for the search bar
    const filterButtons = document.querySelectorAll('.btn-group .btn');
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            filterButtons.forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked button
            this.classList.add('active');

            // Here you would normally update the charts based on the selected filter
            // For demo purposes, we'll just log the selected filter
            console.log('Selected filter:', this.textContent.trim());
        });
    });

    // Advanced filter functionality
    const toggleAdvancedFilterBtn = document.getElementById('toggleAdvancedFilter');
    const closeAdvancedFilterBtn = document.getElementById('closeAdvancedFilter');
    const advancedFilterPanel = document.getElementById('advancedFilterPanel');
    const resetFiltersBtn = document.getElementById('resetFilters');
    const applyAdvancedFiltersBtn = document.getElementById('applyAdvancedFilters');
    const warehouseSearchForm = document.getElementById('warehouseSearchForm');

    // Toggle advanced filter panel
    if (toggleAdvancedFilterBtn && advancedFilterPanel) {
        toggleAdvancedFilterBtn.addEventListener('click', function() {
            if (advancedFilterPanel.style.display === 'none') {
                advancedFilterPanel.style.display = 'block';
                // Add animation
                advancedFilterPanel.style.opacity = '0';
                advancedFilterPanel.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    advancedFilterPanel.style.opacity = '1';
                    advancedFilterPanel.style.transform = 'translateY(0)';
                }, 10);
                toggleAdvancedFilterBtn.innerHTML = '<i class="bi bi-chevron-up"></i> إخفاء خيارات التصفية المتقدمة';
            } else {
                // Add animation
                advancedFilterPanel.style.opacity = '0';
                advancedFilterPanel.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    advancedFilterPanel.style.display = 'none';
                }, 300);
                toggleAdvancedFilterBtn.innerHTML = '<i class="bi bi-sliders"></i> خيارات تصفية متقدمة';
            }
        });
    }

    // Close advanced filter panel
    if (closeAdvancedFilterBtn && advancedFilterPanel) {
        closeAdvancedFilterBtn.addEventListener('click', function() {
            advancedFilterPanel.style.opacity = '0';
            advancedFilterPanel.style.transform = 'translateY(-10px)';
            setTimeout(() => {
                advancedFilterPanel.style.display = 'none';
            }, 300);
            toggleAdvancedFilterBtn.innerHTML = '<i class="bi bi-sliders"></i> خيارات تصفية متقدمة';
        });
    }

    // Reset filters
    if (resetFiltersBtn) {
        resetFiltersBtn.addEventListener('click', function() {
            // Reset all filter inputs
            document.getElementById('warehouseFilter').value = '';
            document.getElementById('capacityFilter').value = '';
            document.getElementById('dateFilter').value = '';

            // Add animation effect
            const filterInputs = document.querySelectorAll('#advancedFilterPanel select, #advancedFilterPanel input');
            filterInputs.forEach(input => {
                input.style.transition = 'all 0.3s ease';
                input.style.backgroundColor = 'rgba(46, 204, 113, 0.1)';
                setTimeout(() => {
                    input.style.backgroundColor = '';
                }, 500);
            });
        });
    }

    // Apply advanced filters
    if (applyAdvancedFiltersBtn && warehouseSearchForm) {
        applyAdvancedFiltersBtn.addEventListener('click', function() {
            // Get filter values
            const warehouseFilter = document.getElementById('warehouseFilter').value;
            const capacityFilter = document.getElementById('capacityFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;

            // Create hidden inputs for the form
            if (warehouseFilter) {
                const warehouseInput = document.createElement('input');
                warehouseInput.type = 'hidden';
                warehouseInput.name = 'warehouse';
                warehouseInput.value = warehouseFilter;
                warehouseSearchForm.appendChild(warehouseInput);
            }

            if (capacityFilter) {
                const capacityInput = document.createElement('input');
                capacityInput.type = 'hidden';
                capacityInput.name = 'capacity';
                capacityInput.value = capacityFilter;
                warehouseSearchForm.appendChild(capacityInput);
            }

            if (dateFilter) {
                const dateInput = document.createElement('input');
                dateInput.type = 'hidden';
                dateInput.name = 'date';
                dateInput.value = dateFilter;
                warehouseSearchForm.appendChild(dateInput);
            }

            // Submit the form
            warehouseSearchForm.submit();
        });
    }

    // Real-time filtering for the warehouse table (client-side filtering)
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const sortFilter = document.getElementById('sortFilter');

    if (searchInput && statusFilter && sortFilter) {
        const tableRows = document.querySelectorAll('.warehouse-table tbody tr');

        // Function to filter table rows
        function filterTable() {
            const searchTerm = searchInput.value.toLowerCase();
            const statusValue = statusFilter.value.toLowerCase();

            tableRows.forEach(row => {
                if (row.classList.contains('empty-state-row')) return; // Skip empty state row

                const warehouseName = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                const warehouseLocation = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                const warehouseStatus = row.querySelector('td:nth-child(8)').textContent.toLowerCase();

                const matchesSearch = warehouseName.includes(searchTerm) || warehouseLocation.includes(searchTerm);
                const matchesStatus = statusValue === '' || warehouseStatus.includes(statusValue);

                if (matchesSearch && matchesStatus) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });

            // Check if any rows are visible
            let visibleRows = 0;
            tableRows.forEach(row => {
                if (row.style.display !== 'none' && !row.classList.contains('empty-state-row')) {
                    visibleRows++;
                }
            });

            // Show empty state if no rows are visible
            const emptyStateRow = document.querySelector('.empty-state-row');
            if (emptyStateRow) {
                if (visibleRows === 0) {
                    emptyStateRow.style.display = '';
                } else {
                    emptyStateRow.style.display = 'none';
                }
            }
        }

        // Add event listeners for real-time filtering
        searchInput.addEventListener('input', filterTable);
        statusFilter.addEventListener('change', filterTable);
    }

    // Material movements filtering
    const movementFilters = document.querySelectorAll('.movement-filter');
    const dateFilters = document.querySelectorAll('.date-filter');
    const movementStartDate = document.getElementById('movementStartDate');
    const movementEndDate = document.getElementById('movementEndDate');
    const applyDateFilter = document.getElementById('applyDateFilter');

    if (movementFilters.length > 0) {
        const movementRows = document.querySelectorAll('.warehouse-table:nth-of-type(2) tbody tr');

        // Filter by movement type
        movementFilters.forEach(filter => {
            filter.addEventListener('click', function(e) {
                e.preventDefault();

                const filterType = this.getAttribute('data-filter');

                movementRows.forEach(row => {
                    const movementType = row.querySelector('td:nth-child(4) .badge').textContent.trim();

                    if (filterType === 'all') {
                        row.style.display = '';
                    } else if (filterType === 'in' && movementType === 'إدخال') {
                        row.style.display = '';
                    } else if (filterType === 'out' && movementType === 'إخراج') {
                        row.style.display = '';
                    } else if (filterType === 'transfer' && movementType === 'نقل') {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });

                // Update dropdown button text
                document.getElementById('movementFilterDropdown').innerHTML =
                    '<i class="bi bi-funnel me-1"></i> ' + this.textContent;
            });
        });

        // Filter by date period
        dateFilters.forEach(filter => {
            filter.addEventListener('click', function(e) {
                e.preventDefault();

                const period = this.getAttribute('data-period');
                const today = new Date();
                let startDate = new Date();

                // Set start date based on period
                if (period === 'today') {
                    // Start date is today, already set
                } else if (period === 'week') {
                    // Start date is 7 days ago
                    startDate.setDate(today.getDate() - 7);
                } else if (period === 'month') {
                    // Start date is 30 days ago
                    startDate.setDate(today.getDate() - 30);
                }

                // Format dates for comparison
                const startDateStr = startDate.toISOString().split('T')[0];
                const todayStr = today.toISOString().split('T')[0];

                // Update date inputs
                if (movementStartDate) movementStartDate.value = startDateStr;
                if (movementEndDate) movementEndDate.value = todayStr;

                // Filter rows by date
                filterMovementsByDate(startDate, today);

                // Update dropdown button text
                document.getElementById('movementFilterDropdown').innerHTML =
                    '<i class="bi bi-funnel me-1"></i> ' + this.textContent;
            });
        });

        // Apply custom date filter
        if (applyDateFilter) {
            applyDateFilter.addEventListener('click', function() {
                if (!movementStartDate || !movementEndDate) return;

                const startDateStr = movementStartDate.value;
                const endDateStr = movementEndDate.value;

                if (!startDateStr || !endDateStr) {
                    alert('الرجاء تحديد تاريخ البداية والنهاية');
                    return;
                }

                const startDate = new Date(startDateStr);
                const endDate = new Date(endDateStr);

                // Add one day to end date to include the end date in the range
                endDate.setDate(endDate.getDate() + 1);

                filterMovementsByDate(startDate, endDate);

                // Update dropdown button text
                document.getElementById('movementFilterDropdown').innerHTML =
                    '<i class="bi bi-funnel me-1"></i> تصفية مخصصة';
            });
        }

        // Function to filter movements by date
        function filterMovementsByDate(startDate, endDate) {
            movementRows.forEach(row => {
                const dateCell = row.querySelector('td:nth-child(2)');
                if (!dateCell) return;

                const dateText = dateCell.textContent.trim();
                const dateParts = dateText.split('-');

                // Check if we have a valid date format (YYYY-MM-DD)
                if (dateParts.length !== 3) return;

                const rowDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);

                if (rowDate >= startDate && rowDate <= endDate) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
    }
</script>
{% endblock %}
